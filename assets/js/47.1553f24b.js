(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{462:function(e,t,r){"use strict";r.r(t);var a=r(65),s=Object(a.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"容量问题"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#容量问题"}},[e._v("#")]),e._v(" 容量问题")]),e._v(" "),r("h2",{attrs:{id:"容量不足迁移文件到有空间的磁盘"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#容量不足迁移文件到有空间的磁盘"}},[e._v("#")]),e._v(" 容量不足迁移文件到有空间的磁盘")]),e._v(" "),r("ul",[r("li",[e._v("公司内部服务器有问题,整的很粗糙,明明有个250G的硬盘没有使用,反而把根目录的50G挤满了")]),e._v(" "),r("li",[e._v("所以导致了gitlab三天两头挂,查看日志就发现是没有空间了,所以我就经过一番查询和询问,找到了解决方法")]),e._v(" "),r("li",[e._v("群里的大佬说")])]),e._v(" "),r("blockquote",[r("p",[e._v("你要看docker里面跑的是啥")]),e._v(" "),r("p",[e._v("docker容器里面有没有日志什么的")]),e._v(" "),r("p",[e._v("他这个要把docker的存储位置挪到/home目录下去")]),e._v(" "),r("p",[e._v("不然迟早还是要满")]),e._v(" "),r("p",[e._v("数据挪到/home下面去")]),e._v(" "),r("p",[e._v("再在/var/lib下面挂一个软连接")])]),e._v(" "),r("ul",[r("li",[r("p",[e._v("我查到的解决方法在这个"),r("a",{attrs:{href:"https://www.jianshu.com/p/993c26653231",target:"_blank",rel:"noopener noreferrer"}},[e._v("链接"),r("OutboundLink")],1)])]),e._v(" "),r("li",[r("p",[e._v("正经的做法是")])]),e._v(" "),r("li",[r("p",[e._v("我首先分析了gitlab的日志,发现很多地方都在说设备没有空间")]),e._v(" "),r("div",{staticClass:"language-shell extra-class"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("==")]),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" /var/log/gitlab/logrotate/current "),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<=")]),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_17:44:45.48774 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/log/gitlab/gitlab-rails/production_json.log.1: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_17:44:45.49271 error: error writing to /var/log/gitlab/gitaly/gitaly_ruby_json.log.1: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_17:44:45.49272 error: error copying /var/log/gitlab/gitaly/gitaly_ruby_json.log to /var/log/gitlab/gitaly/gitaly_ruby_json.log.1: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_18:44:45.50860 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/opt/gitlab/logrotate/logrotate.status.tmp: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_19:44:45.52490 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/opt/gitlab/logrotate/logrotate.status.tmp: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_20:44:45.53921 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/opt/gitlab/logrotate/logrotate.status.tmp: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_21:44:45.55367 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/opt/gitlab/logrotate/logrotate.status.tmp: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_22:44:45.56807 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/opt/gitlab/logrotate/logrotate.status.tmp: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-07_23:44:45.58194 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/opt/gitlab/logrotate/logrotate.status.tmp: No space left on device\n"),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v("-06-08_00:44:45.59600 error: error creating output "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" /var/opt/gitlab/logrotate/logrotate.status.tmp: No space left on device\n\n")])])])]),e._v(" "),r("li",[r("p",[e._v("然后呢我就查看了服务器的磁盘存储情况,命令是"),r("code",[e._v("df -h")])]),e._v(" "),r("div",{staticClass:"language-shell extra-class"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[e._v("文件系统               容量  已用  可用 已用% 挂载点\ndevtmpfs               "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".8G     "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".8G    "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("% /dev\ntmpfs                  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".8G   28K  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".8G    "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("% /dev/shm\ntmpfs                  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".8G  813M  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".0G   "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("11")]),e._v("% /run\ntmpfs                  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".8G     "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v(".8G    "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("% /sys/fs/cgroup\n/dev/mapper/rhel-root   50G   50G   20K  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),e._v("% /\n/dev/sda1             1014M  287M  728M   "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("29")]),e._v("% /boot\n/dev/mapper/rhel-home  247G  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v(".2G  245G    "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("% /home\noverlay                 50G   50G   20K  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),e._v("% /var/lib/docker/overlay2/957f5284452697a924dadafb7b3c910f74e70651e14d97d4c204f179bb13bbb3/merged\noverlay                 50G   50G   20K  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),e._v("% /var/lib/docker/overlay2/c7a89d988247d76a8494696dffec4d427be2bc03ec630b9c8e4e4c299320293f/merged\ntmpfs                  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(".6G     "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("  "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(".6G    "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("% /run/user/0\n")])])])]),e._v(" "),r("li",[r("p",[e._v("然后发现根目录占满了,然后模糊能看出docker占用空间很大,所以就想办法去把docker目录的文件都移到/home目录")])]),e._v(" "),r("li",[r("p",[e._v("首先去把所有容器停掉,但是我发现有几个容器没法停,stop和kill命令都不行,kill命令还会说这个容器不是运行状态")])]),e._v(" "),r("li",[r("p",[e._v("经过查询,发现这种容器是幽灵容器,就是已经死掉了但是还飘在哪里,所以可以放心的删掉,就使用了"),r("code",[e._v("docker rm -f")])])]),e._v(" "),r("li",[r("p",[e._v("之后呢,需要使用"),r("code",[e._v("service docker stop")]),e._v("命令把整个docker停掉,这里我刚开始没记住,通过这个"),r("a",{attrs:{href:"https://www.cnblogs.com/shiyublog/p/9858786.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("链接"),r("OutboundLink")],1),e._v("才发现的")])]),e._v(" "),r("li",[r("p",[e._v("之后迁移文件,使用"),r("code",[e._v("mv /var/lib/docker /home/docker")]),e._v("命令把原先的docker文件夹整个转移到home文件夹下")])]),e._v(" "),r("li",[r("p",[e._v("然后这里我搜到的解决方法是让我使用"),r("code",[e._v("ln -s /home/docker /var/lib/docker")]),e._v("命令创建软链接,但我使用之后出现了无法启动容器的问题,这有两种可能,一种是我之前没执行"),r("code",[e._v("service docker stop")]),e._v("命令,一种是软链接创建的有问题")])]),e._v(" "),r("li",[r("p",[e._v("我cd到"),r("code",[e._v("var/lib")]),e._v("目录删除了软链接,使用的命令是"),r("code",[e._v("unlink docker")])])]),e._v(" "),r("li",[r("p",[e._v("然后创建新的软链接"),r("code",[e._v("ln -s /home/docker /var/lib")]),e._v(",因为mv命令执行完,lib文件夹下就没有docker文件夹了,我猜测可能问题出现在这里")])]),e._v(" "),r("li",[r("p",[e._v("之后我启动docker服务"),r("code",[e._v("service docker start")])])]),e._v(" "),r("li",[r("p",[e._v("然后启动容器,这下一切正常了,服务器空间也清理出来了")])])])])}),[],!1,null,null,null);t.default=s.exports}}]);